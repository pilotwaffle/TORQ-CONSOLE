name: Capability Matrix Validation

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # Daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  validate-capabilities:
    name: Validate Capability Matrix
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for git SHA

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
        pip install pytest pytest-json-report

    - name: Run Persona Tests (Basic User)
      run: |
        python -m pytest tests/capability/test_persona_basic_user.py -v \
          --json-report --json-report-file=report_basic_user.json \
          --tb=short || true

    - name: Run Persona Tests (Power User)
      run: |
        python -m pytest tests/capability/test_persona_power_user.py -v \
          --json-report --json-report-file=report_power_user.json \
          --tb=short || true

    - name: Run Core Capability Tests
      run: |
        python -m pytest tests/capability/test_core_capabilities.py -v \
          --json-report --json-report-file=report_core.json \
          --tb=short || true

    - name: Generate Capability Report
      run: |
        python scripts/generate_capability_report.py

    - name: Check Success Rate
      run: |
        python -c "
import json
import sys

# Load latest capability report
try:
    with open('reports/capabilities/latest_capability_report.json') as f:
        report = json.load(f)

    success_rate = report['summary']['success_rate']
    print(f\"Success Rate: {success_rate}%\")

    # Fail if success rate is below 80%
    if success_rate < 80:
        print(f\"FAILED: Success rate {success_rate}% is below 80% threshold\")
        sys.exit(1)
    else:
        print(f\"PASSED: Success rate {success_rate}% meets threshold\")

except Exception as e:
    print(f\"Error reading capability report: {e}\")
    sys.exit(1)
"

    - name: Upload Capability Reports
      uses: actions/upload-artifact@v3
      with:
        name: capability-reports-py${{ matrix.python-version }}
        path: |
          reports/capabilities/
          report_basic_user.json
          report_power_user.json
          report_core.json
        retention-days: 30

    - name: Upload Latest Report as Artifact
      uses: actions/upload-artifact@v3
      with:
        name: latest-capability-report
        path: reports/capabilities/latest_capability_report.json
        retention-days: 90

  # Summary job to aggregate results across Python versions
  capability-summary:
    name: Capability Validation Summary
    runs-on: ubuntu-latest
    needs: validate-capabilities
    if: always()

    steps:
    - name: Download All Reports
      uses: actions/download-artifact@v3
      with:
        pattern: capability-reports-py*
        path: all-reports

    - name: Generate Summary
      run: |
        echo "# TORQ Console Capability Validation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Test Results Across Python Versions" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        for dir in all-reports/capability-reports-py*; do
          if [ -f "$dir/reports/capabilities/latest_capability_report.json" ]; then
            version=$(echo $dir | grep -o 'py[0-9.]*')
            echo "### Python $version" >> $GITHUB_STEP_SUMMARY

            python -c "
import json
with open('$dir/reports/capabilities/latest_capability_report.json') as f:
    report = json.load(f)

summary = report['summary']
print(f'- Total Capabilities: {summary[\"total_capabilities\"]}')
print(f'- Passed: {summary[\"passed\"]}')
print(f'- Failed: {summary[\"failed\"]}')
print(f'- Success Rate: {summary[\"success_rate\"]:.1f}%')
print()
" >> $GITHUB_STEP_SUMMARY
          fi
        done

    - name: Check Overall Success
      run: |
        # Determine if overall validation should pass
        # Success if at least one Python version has >=80% success rate
        overall_success=false

        for dir in all-reports/capability-reports-py*; do
          if [ -f "$dir/reports/capabilities/latest_capability_report.json" ]; then
            success_rate=$(python -c "
import json
with open('$dir/reports/capabilities/latest_capability_report.json') as f:
    report = json.load(f)
print(report['summary']['success_rate'])
")

            if (( $(echo "$success_rate >= 80" | bc -l) )); then
              overall_success=true
              break
            fi
          fi
        done

        if [ "$overall_success" = true ]; then
          echo "✅ Overall capability validation PASSED"
        else
          echo "❌ Overall capability validation FAILED"
          exit 1
        fi