name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Free up runner disk space
      run: |
        sudo apt-get clean -y || true
        # Remove common large SDKs/tools that are safe to remove on hosted runners
        sudo rm -rf /usr/share/dotnet || true
        sudo rm -rf /usr/local/lib/android || true
        sudo rm -rf /opt/ghc || true
        sudo rm -rf /home/runner/.cache/ghcup || true
        sudo rm -rf /home/runner/.cache/cargo || true
        # Prune docker images and unused data
        docker system prune -af || true

    - name: Cache pip cache and wheels
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install Python dependencies
      env:
        PIP_DISABLE_PIP_VERSION_CHECK: '1'
      run: |
        python -m pip install --upgrade pip setuptools wheel
        # Use the cached dir to avoid re-downloading wheels every run and prefer binary wheels
        pip install --prefer-binary --cache-dir ~/.cache/pip -e .

    - name: Lint check
      run: |
        pip install ruff
        ruff check torq_console/ || true

    - name: Type check
      run: |
        pip install mypy
        mypy torq_console/ || true

    - name: Success
      run: echo "CI checks passed!"
