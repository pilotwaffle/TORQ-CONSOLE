<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TORQ CONSOLE - Enhanced AI Pair Programming with MCP</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        .panel-transition { transition: all 0.3s ease-in-out; }
        .mcp-panel { min-width: 280px; max-width: 320px; }
        .chat-panel { min-width: 600px; flex: 2; }
        .diff-panel { min-width: 300px; max-width: 350px; }
        .monaco-editor { border-radius: 8px; }
        .diff-viewer { font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; }
        .guided-prompt {
            background: linear-gradient(135deg, #1e40af, #7c3aed);
            border: 1px solid #3b82f6;
            animation: pulse 2s infinite;
        }
        .mcp-tool-card {
            background: linear-gradient(135deg, #065f46, #064e3b);
            border: 1px solid #10b981;
        }
        .voice-indicator {
            animation: voice-pulse 1.5s ease-in-out infinite;
        }
        @keyframes voice-pulse {
            0%, 100% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.1); opacity: 1; }
        }
        .ideation-mode {
            background: linear-gradient(135deg, #7c2d12, #ea580c);
            border: 1px solid #f97316;
        }

        /* Inline Editor Styles */
        .inline-editor-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .inline-editor-panel {
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .ghost-text {
            color: #6b7280;
            font-style: italic;
            background: rgba(59, 130, 246, 0.1);
            border-left: 2px solid #3b82f6;
            padding-left: 8px;
            margin: 4px 0;
            border-radius: 4px;
        }

        .ghost-text-preview {
            position: relative;
            display: inline-block;
        }

        .ghost-text-suggestion {
            position: absolute;
            background: rgba(59, 130, 246, 0.1);
            color: #6b7280;
            border: 1px dashed #3b82f6;
            padding: 2px 4px;
            border-radius: 3px;
            z-index: 10;
            animation: ghost-fade-in 0.3s ease-in;
        }

        @keyframes ghost-fade-in {
            from { opacity: 0; transform: translateY(-4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .code-editor {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 6px;
            padding: 12px;
            min-height: 200px;
            color: #e2e8f0;
            resize: vertical;
        }

        .code-editor:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .inline-editor-toolbar {
            background: #374151;
            border-bottom: 1px solid #4b5563;
            padding: 8px 12px;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .keyboard-shortcut {
            background: #374151;
            border: 1px solid #4b5563;
            border-radius: 3px;
            padding: 2px 6px;
            font-size: 11px;
            font-family: monospace;
            color: #9ca3af;
        }

        .quick-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .quick-action-btn {
            background: #374151;
            border: 1px solid #4b5563;
            color: #d1d5db;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-action-btn:hover {
            background: #4b5563;
            border-color: #6b7280;
        }

        .edit-mode-indicator {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #3b82f6;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 1001;
            animation: slide-in 0.3s ease-out;
        }

        @keyframes slide-in {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .refinement-workflow {
            background: #0f172a;
            border: 1px solid #1e293b;
            border-radius: 6px;
            margin-top: 12px;
            overflow: hidden;
        }

        .workflow-step {
            padding: 12px;
            border-bottom: 1px solid #1e293b;
            display: flex;
            align-items: center;
            justify-content: between;
        }

        .workflow-step:last-child {
            border-bottom: none;
        }

        .workflow-step.active {
            background: rgba(59, 130, 246, 0.1);
            border-left: 3px solid #3b82f6;
        }

        .workflow-step.completed {
            background: rgba(16, 185, 129, 0.1);
            border-left: 3px solid #10b981;
        }

        .context-drag-zone {
            border: 2px dashed #374151;
            border-radius: 6px;
            padding: 20px;
            text-align: center;
            color: #6b7280;
            transition: all 0.3s;
        }

        .context-drag-zone.drag-over {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        /* Command Palette Styles */
        .command-palette-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 10vh;
        }

        .command-palette-panel {
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 70vh;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            animation: palette-slide-in 0.2s ease-out;
        }

        @keyframes palette-slide-in {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .command-palette-search {
            padding: 16px;
            border-bottom: 1px solid #374151;
        }

        .command-palette-input {
            width: 100%;
            background: #374151;
            border: 1px solid #4b5563;
            border-radius: 6px;
            padding: 12px 16px;
            color: #e5e7eb;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s;
        }

        .command-palette-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .command-palette-input::placeholder {
            color: #9ca3af;
        }

        .command-palette-results {
            max-height: 400px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #4b5563 #1f2937;
        }

        .command-palette-results::-webkit-scrollbar {
            width: 6px;
        }

        .command-palette-results::-webkit-scrollbar-track {
            background: #1f2937;
        }

        .command-palette-results::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 3px;
        }

        .command-palette-item {
            padding: 12px 16px;
            border-bottom: 1px solid #374151;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background-color 0.2s;
        }

        .command-palette-item:hover,
        .command-palette-item.selected {
            background: #374151;
        }

        .command-palette-item.selected {
            border-left: 3px solid #3b82f6;
        }

        .command-palette-item:last-child {
            border-bottom: none;
        }

        .command-item-left {
            display: flex;
            align-items: center;
            flex: 1;
            min-width: 0;
        }

        .command-item-icon {
            width: 16px;
            height: 16px;
            margin-right: 12px;
            color: #9ca3af;
            flex-shrink: 0;
        }

        .command-item-content {
            flex: 1;
            min-width: 0;
        }

        .command-item-title {
            font-weight: 500;
            color: #e5e7eb;
            font-size: 14px;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .command-item-title.highlighted {
            background: rgba(59, 130, 246, 0.3);
            padding: 0 2px;
            border-radius: 2px;
        }

        .command-item-description {
            font-size: 12px;
            color: #9ca3af;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .command-item-right {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .command-item-category {
            background: #374151;
            color: #9ca3af;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .command-item-shortcut {
            background: #374151;
            border: 1px solid #4b5563;
            border-radius: 3px;
            padding: 2px 6px;
            font-size: 11px;
            font-family: monospace;
            color: #9ca3af;
        }

        .command-item-favorite {
            color: #fbbf24;
            width: 12px;
            height: 12px;
        }

        .command-palette-footer {
            padding: 8px 16px;
            border-top: 1px solid #374151;
            background: #111827;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .command-palette-help {
            display: flex;
            gap: 16px;
            font-size: 11px;
            color: #6b7280;
        }

        .command-palette-help-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .command-palette-status {
            font-size: 11px;
            color: #6b7280;
        }

        .command-palette-empty {
            padding: 32px 16px;
            text-align: center;
            color: #6b7280;
        }

        .command-palette-empty-icon {
            width: 32px;
            height: 32px;
            margin: 0 auto 8px;
            opacity: 0.5;
        }

        .command-match-highlight {
            background: rgba(59, 130, 246, 0.3);
            color: #60a5fa;
            padding: 0 1px;
            border-radius: 2px;
        }

        .command-category-filter {
            display: flex;
            gap: 4px;
            padding: 8px 16px;
            border-bottom: 1px solid #374151;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .command-category-filter::-webkit-scrollbar {
            display: none;
        }

        .category-filter-chip {
            background: #374151;
            color: #9ca3af;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .category-filter-chip:hover {
            background: #4b5563;
            color: #e5e7eb;
        }

        .category-filter-chip.active {
            background: #3b82f6;
            color: white;
            border-color: #2563eb;
        }

        .command-recent-section {
            padding: 12px 16px;
            border-bottom: 1px solid #374151;
        }

        .command-recent-title {
            font-size: 12px;
            color: #9ca3af;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .command-recent-items {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .command-recent-item {
            background: #374151;
            color: #e5e7eb;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .command-recent-item:hover {
            background: #4b5563;
        }

        /* TypeScript Interface Documentation */
        .ts-interface-docs {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 16px;
            max-width: 400px;
            font-family: monospace;
            font-size: 12px;
            color: #e5e7eb;
            z-index: 1500;
            display: none;
        }

        .ts-interface-title {
            color: #3b82f6;
            font-weight: bold;
            margin-bottom: 8px;
        }

        /* Force input text to be black */
        .ai-input {
            color: #000000 !important;
        }

        /* Scrollbar styling for MCP tools */
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .scrollbar-thin::-webkit-scrollbar-track {
            background: #1f2937;
            border-radius: 3px;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 3px;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        /* Line clamp utility */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* MCP Tool Card Hover Effects */
        .mcp-tool-enhanced {
            transition: all 0.2s ease-in-out;
        }

        .mcp-tool-enhanced:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        /* Category Badge Animation */
        .category-badge {
            transition: all 0.2s ease-in-out;
        }

        /* Tool Icon Pulse on Hover */
        @keyframes tool-icon-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .group:hover .tool-icon {
            animation: tool-icon-pulse 0.5s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-900 text-white h-screen overflow-hidden flex flex-col" x-data="torqConsole()">
    <!-- Header with TORQ Logo and Model Selector -->
    <header class="bg-gray-800 border-b border-gray-700 p-3 flex items-center justify-between flex-shrink-0">
        <div class="flex items-center space-x-4">
            <!-- TORQ Logo -->
            <div class="w-12 h-12">
                <svg width="48" height="48" viewBox="0 0 512 512" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <radialGradient id="bgGradient" cx="50%" cy="50%" r="50%">
                            <stop offset="0%" stop-color="#23272c"/>
                            <stop offset="100%" stop-color="#181a1e"/>
                        </radialGradient>
                        <linearGradient id="redGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stop-color="#ff3333"/>
                            <stop offset="100%" stop-color="#cc0000"/>
                        </linearGradient>
                    </defs>
                    <circle cx="256" cy="256" r="240" stroke="#4a90e2" stroke-width="8" fill="url(#bgGradient)"/>
                    <path d="M180 140 L332 140 L332 180 L290 180 L290 320 L222 320 L222 180 L180 180 Z" fill="url(#redGradient)"/>
                </svg>
            </div>
            <div>
                <h1 class="text-xl font-bold text-blue-400">TORQ CONSOLE</h1>
                <p class="text-xs text-gray-400">Enhanced AI Pair Programming with MCP</p>
            </div>
        </div>

        <!-- Mode Indicators and Model Selector -->
        <div class="flex items-center space-x-4">
            <!-- Voice Indicator -->
            <div x-show="voiceEnabled" class="voice-indicator bg-green-600 text-white px-3 py-1 rounded-full text-sm">
                üé§ Voice Active
            </div>

            <!-- Ideation Mode -->
            <div x-show="ideationMode" class="ideation-mode text-white px-3 py-1 rounded-full text-sm">
                üí° Ideation Mode
            </div>

            <!-- Model Selector -->
            <select x-model="selectedModel" @change="updateModel()"
                    class="bg-gray-700 border border-gray-600 rounded px-3 py-1 text-sm focus:outline-none focus:border-blue-500">
                <option value="claude-sonnet-4-5-20250929">Claude Sonnet 4.5 (Latest)</option>
                <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet</option>
                <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                <option value="gpt-4-turbo-preview">GPT-4 Turbo</option>
                <option value="gpt-4o">GPT-4o</option>
                <option value="deepseek-chat">DeepSeek Chat</option>
                <option value="llama-3.1-405b">Llama 3.1 405B</option>
                <option value="gemini-pro">Gemini Pro</option>
            </select>
        </div>
    </header>

    <!-- Main 3-Panel Layout: MCP | Chat | Diffs -->
    <div class="flex flex-1 overflow-hidden">
        <!-- Left Panel: MCP Tools & Integration -->
        <div class="mcp-panel bg-gray-800 border-r border-gray-700 flex flex-col panel-transition">
            <!-- MCP Panel Header -->
            <div class="p-4 border-b border-gray-700">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-green-400">üîß Tools & Integrations</h2>
                    <button @click="connectMCP()" class="bg-green-600 hover:bg-green-700 px-3 py-1 rounded text-sm">
                        Connect
                    </button>
                </div>
                <p class="text-xs text-gray-400 mt-1">AI Models, Connections & Capabilities</p>
            </div>

            <!-- MCP Server Status -->
            <div class="p-4 border-b border-gray-700">
                <h3 class="text-sm font-medium text-gray-300 mb-2">Connected Servers</h3>
                <div class="space-y-2">
                    <template x-for="server in mcpServers" :key="server.endpoint">
                        <div class="mcp-tool-card p-2 rounded text-sm">
                            <div class="flex items-center justify-between">
                                <span x-text="server.name" class="text-green-300"></span>
                                <span class="w-2 h-2 bg-green-400 rounded-full"></span>
                            </div>
                            <p class="text-xs text-gray-400" x-text="server.endpoint"></p>
                        </div>
                    </template>
                    <div x-show="mcpServers.length === 0" class="text-gray-500 text-sm">
                        No MCP servers connected
                    </div>
                </div>
            </div>

            <!-- Available MCP Tools - Enhanced with Categories -->
            <div class="p-4 border-b border-gray-700">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-sm font-medium text-gray-300">Available Tools</h3>
                    <span class="text-xs text-gray-500" x-text="mcpTools.length + ' tools'"></span>
                </div>

                <!-- Category Filter Tabs -->
                <div x-show="mcpCategories.length > 0" class="flex gap-1 mb-3 overflow-x-auto pb-2 scrollbar-thin">
                    <button @click="selectedMcpCategory = 'all'; filterMcpTools()"
                            :class="selectedMcpCategory === 'all' ? 'bg-blue-600 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'"
                            class="px-2 py-1 rounded text-xs whitespace-nowrap transition-colors">
                        All
                    </button>
                    <template x-for="category in mcpCategories" :key="category">
                        <button @click="selectedMcpCategory = category; filterMcpTools()"
                                :class="selectedMcpCategory === category ? 'bg-blue-600 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'"
                                class="px-2 py-1 rounded text-xs whitespace-nowrap transition-colors"
                                x-text="category">
                        </button>
                    </template>
                </div>

                <!-- Search/Filter Input -->
                <div class="mb-3">
                    <input type="text" x-model="mcpSearchQuery" @input="filterMcpTools()"
                           placeholder="üîç Search tools..."
                           class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm text-white placeholder-gray-400 focus:outline-none focus:border-blue-500">
                </div>

                <!-- Tools List - Grouped by Category -->
                <div class="space-y-2 max-h-96 overflow-y-auto scrollbar-thin">
                    <template x-for="tool in filteredMcpTools" :key="tool.name">
                        <div @click="useMcpTool(tool)"
                             :title="tool.tooltip"
                             class="w-full text-left p-3 bg-gray-700 hover:bg-gray-600 rounded-lg cursor-pointer transition-all border border-transparent hover:border-blue-500 group">

                            <!-- Tool Header with Icon and Name -->
                            <div class="flex items-start gap-2 mb-1">
                                <span class="text-xl flex-shrink-0 tool-icon" x-text="tool.icon"></span>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center justify-between gap-2">
                                        <span class="font-medium text-white text-sm truncate" x-text="tool.name"></span>
                                        <span class="text-xs px-2 py-0.5 rounded bg-gray-600 text-gray-300 group-hover:bg-blue-600 group-hover:text-white transition-colors flex-shrink-0"
                                              x-text="tool.category"></span>
                                    </div>

                                    <!-- Friendly Description -->
                                    <div class="text-xs text-gray-300 mt-1 line-clamp-2" x-text="tool.user_friendly_description"></div>

                                    <!-- Use Case -->
                                    <div class="text-xs text-blue-300 mt-1 italic" x-text="'üí° ' + tool.use_case"></div>

                                    <!-- Parameter Info (collapsed by default) -->
                                    <div x-show="showToolParams === tool.name"
                                         x-transition
                                         class="mt-2 p-2 bg-gray-800 rounded text-xs">
                                        <div class="text-gray-400 mb-1">Parameters:</div>
                                        <div class="text-gray-300" x-text="tool.parameter_summary"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Quick Action Buttons -->
                            <div class="flex gap-1 mt-2">
                                <button @click.stop="useMcpTool(tool)"
                                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white text-xs px-2 py-1 rounded transition-colors">
                                    ‚ñ∂ Use Tool
                                </button>
                                <button @click.stop="showToolParams = showToolParams === tool.name ? null : tool.name"
                                        class="bg-gray-600 hover:bg-gray-500 text-white text-xs px-2 py-1 rounded transition-colors">
                                    ‚ÑπÔ∏è
                                </button>
                            </div>
                        </div>
                    </template>

                    <!-- Empty State -->
                    <div x-show="filteredMcpTools.length === 0" class="text-center py-8 text-gray-500">
                        <div class="text-2xl mb-2">üîç</div>
                        <div class="text-sm" x-show="mcpSearchQuery">No tools match "<span x-text="mcpSearchQuery"></span>"</div>
                        <div class="text-sm" x-show="!mcpSearchQuery && mcpTools.length === 0">No MCP servers connected</div>
                        <div class="text-sm" x-show="!mcpSearchQuery && mcpTools.length > 0 && selectedMcpCategory !== 'all'">
                            No tools in "<span x-text="selectedMcpCategory"></span>" category
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ideation Tools -->
            <div class="p-4 border-b border-gray-700">
                <h3 class="text-sm font-medium text-orange-400 mb-2">üí° Ideation</h3>
                <div class="space-y-2">
                    <button @click="startIdeation('web')"
                            :class="activeTools.includes('web_search') ?
                                'w-full bg-green-600 hover:bg-green-700 px-3 py-2 rounded text-sm ring-2 ring-green-400' :
                                'w-full bg-gray-600 hover:bg-gray-700 px-3 py-2 rounded text-sm'">
                        üîç Research Assistant
                        <span v-if="activeTools.includes('web_search')" class="ml-1">‚úì</span>
                    </button>
                    <button @click="startIdeation('github')"
                            :class="activeTools.includes('github_examples') ?
                                'w-full bg-purple-600 hover:bg-purple-700 px-3 py-2 rounded text-sm ring-2 ring-purple-400' :
                                'w-full bg-gray-600 hover:bg-gray-700 px-3 py-2 rounded text-sm'">
                        üìö Code Library
                        <span v-if="activeTools.includes('github_examples')" class="ml-1">‚úì</span>
                    </button>
                    <button @click="startPrototyping()"
                            :class="planningMode ?
                                'w-full bg-blue-600 hover:bg-blue-700 px-3 py-2 rounded text-sm ring-2 ring-blue-400' :
                                'w-full bg-gray-600 hover:bg-gray-700 px-3 py-2 rounded text-sm'">
                        üèóÔ∏è App Builder
                        <span v-if="planningMode" class="ml-1">‚úì</span>
                    </button>
                    <button @click="startCodeWriting()"
                            :class="codeWritingMode ?
                                'w-full bg-red-600 hover:bg-red-700 px-3 py-2 rounded text-sm ring-2 ring-red-400' :
                                'w-full bg-gray-600 hover:bg-gray-700 px-3 py-2 rounded text-sm'">
                        ‚úçÔ∏è Write/Update Code
                        <span v-if="codeWritingMode" class="ml-1">‚úì</span>
                    </button>
                </div>
            </div>

            <!-- Creative Tools -->
            <div class="p-4 border-b border-gray-700">
                <h3 class="text-sm font-medium text-purple-400 mb-2">üé® Creative Tools</h3>
                <div class="space-y-2">
                    <button @click="startImageGeneration()"
                            :class="imageGenerationMode ?
                                'w-full bg-purple-600 hover:bg-purple-700 px-3 py-2 rounded text-sm ring-2 ring-purple-400' :
                                'w-full bg-gray-600 hover:bg-gray-700 px-3 py-2 rounded text-sm'">
                        üé® Create Image
                        <span v-if="imageGenerationMode" class="ml-1">‚úì</span>
                    </button>
                    <button @click="startVideoGeneration()"
                            :class="videoGenerationMode ?
                                'w-full bg-purple-600 hover:bg-purple-700 px-3 py-2 rounded text-sm ring-2 ring-purple-400' :
                                'w-full bg-gray-600 hover:bg-gray-700 px-3 py-2 rounded text-sm'">
                        üé¨ Create Video
                        <span v-if="videoGenerationMode" class="ml-1">‚úì</span>
                    </button>
                </div>
            </div>

            <!-- Development Tools -->
            <div class="p-4 border-b border-gray-700">
                <h3 class="text-sm font-medium text-green-400 mb-2">üöÄ Development Tools</h3>
                <div class="space-y-2">
                    <button @click="pushToGitHub()"
                            class="w-full bg-green-600 hover:bg-green-700 px-3 py-2 rounded text-sm">
                        üöÄ Push to GitHub
                    </button>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="p-4 flex-1">
                <h3 class="text-sm font-medium text-gray-300 mb-2">Quick Actions</h3>
                <div class="space-y-2">
                    <button @click="newSession()"
                            :class="sessionActive ?
                                'w-full bg-blue-700 hover:bg-blue-800 px-3 py-2 rounded text-sm ring-2 ring-blue-400' :
                                'w-full bg-blue-600 hover:bg-blue-700 px-3 py-2 rounded text-sm'">
                        New Session
                        <span v-if="sessionActive" class="ml-1">‚óè</span>
                    </button>
                    <button @click="toggleVoice()"
                            class="w-full bg-green-600 hover:bg-green-700 px-3 py-2 rounded text-sm">
                        üé§ Voice Mode
                    </button>
                    <button @click="exportWorkflow()"
                            class="w-full bg-gray-600 hover:bg-gray-700 px-3 py-2 rounded text-sm">
                        Export Workflow
                    </button>
                </div>
            </div>
        </div>

        <!-- Center Panel: AI Chat & Interactive Shell -->
        <div class="chat-panel flex-1 flex flex-col bg-gray-900">
            <!-- Chat Header -->
            <div class="p-4 border-b border-gray-700 bg-gray-800">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-blue-400">AI Assistant</h2>
                    <div class="flex items-center space-x-2">
                        <span class="text-xs text-gray-400">Session: </span>
                        <span class="text-xs text-green-400" x-text="sessionId"></span>
                    </div>
                </div>

                <!-- Guided Prompt -->
                <div x-show="showGuidedPrompt" class="guided-prompt mt-3 p-3 rounded-lg">
                    <div class="text-sm font-medium text-white mb-2">üöÄ Getting Started</div>
                    <div class="text-xs text-blue-100" x-text="guidedPromptText"></div>
                    <div class="flex space-x-2 mt-2">
                        <button @click="acceptGuidedPrompt()" class="bg-white text-blue-600 px-2 py-1 rounded text-xs">
                            Try it
                        </button>
                        <button @click="dismissGuidedPrompt()" class="bg-blue-600 text-white px-2 py-1 rounded text-xs">
                            Skip
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chat Messages -->
            <div class="flex-1 overflow-y-auto p-4 space-y-4" id="chat-messages">
                <template x-for="message in messages" :key="message.id">
                    <div class="flex" :class="message.role === 'user' ? 'justify-end' : 'justify-start'">
                        <div class="max-w-3xl" :class="message.role === 'user' ? 'bg-blue-600' : 'bg-gray-700'"
                             class="p-3 rounded-lg">
                            <div class="text-sm" x-html="message.content"></div>
                            <div class="text-xs text-gray-300 mt-1" x-text="message.timestamp"></div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Input Area with Mode Toggles -->
            <div class="p-4 border-t border-gray-700 bg-gray-800">
                <!-- Mode Toggles -->
                <div class="flex space-x-2 mb-3">
                    <button @click="toggleMode('ideation')"
                            :class="ideationMode ? 'bg-orange-600' : 'bg-gray-600'"
                            class="px-3 py-1 rounded text-sm">üí° Ideation</button>
                    <button @click="toggleMode('planning')"
                            :class="planningMode ? 'bg-purple-600' : 'bg-gray-600'"
                            class="px-3 py-1 rounded text-sm">üìã Planning</button>
                    <button @click="toggleMode('voice')"
                            :class="voiceEnabled ? 'bg-green-600' : 'bg-gray-600'"
                            class="px-3 py-1 rounded text-sm">üé§ Voice</button>
                </div>

                <!-- Message Input with Inline Editing Support -->
                <div class="flex space-x-2">
                    <div class="flex-1 relative">
                        <input type="text" x-model="currentMessage"
                               @keyup.enter="sendMessage()"
                               @keydown="handleKeyboardShortcuts($event)"
                               placeholder="Ask AI assistant or describe what you want to build... (Ctrl+K for inline edit)"
                               class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-black ai-input focus:outline-none focus:border-blue-500">

                        <!-- Ghost Text Preview -->
                        <div x-show="activeGhostText"
                             class="ghost-text-suggestion"
                             :style="getGhostTextStyle()">
                            <span x-text="activeGhostText?.text" class="text-xs"></span>
                            <div class="text-xs mt-1">
                                <span class="keyboard-shortcut">Tab</span> accept
                                <span class="keyboard-shortcut">Esc</span> dismiss
                            </div>
                        </div>
                    </div>

                    <button @click="sendMessage()"
                            class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">
                        Send
                    </button>

                    <!-- Inline Edit Trigger -->
                    <button @click="showInlineEditor()"
                            class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded text-sm"
                            title="Open Inline Editor (Ctrl+K)">
                        ‚úèÔ∏è Edit
                    </button>
                </div>

                <!-- Keyboard Shortcuts Help -->
                <div class="flex justify-between items-center mt-2 text-xs text-gray-400">
                    <div class="flex space-x-4">
                        <span><span class="keyboard-shortcut">Ctrl+Shift+P</span> Command Palette</span>
                        <span><span class="keyboard-shortcut">Ctrl+K</span> Inline Edit</span>
                        <span><span class="keyboard-shortcut">Alt+Enter</span> Quick Question</span>
                        <span><span class="keyboard-shortcut">Ctrl+.</span> Code Actions</span>
                    </div>
                    <div x-show="inlineEditMode" class="text-blue-400">
                        Inline Edit Mode Active
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel: Diffs & File Changes -->
        <div class="diff-panel bg-gray-800 border-l border-gray-700 flex flex-col panel-transition">
            <!-- Diff Header -->
            <div class="p-4 border-b border-gray-700">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-yellow-400">Changes</h2>
                    <select x-model="diffTool" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs">
                        <option value="delta">Delta</option>
                        <option value="bat">Bat</option>
                        <option value="git">Git</option>
                    </select>
                </div>
                <p class="text-xs text-gray-400 mt-1">Visual diffs and file modifications</p>
            </div>

            <!-- File Tree -->
            <div class="p-4 border-b border-gray-700">
                <h3 class="text-sm font-medium text-gray-300 mb-2">Modified Files</h3>
                <div class="space-y-1 max-h-32 overflow-y-auto">
                    <template x-for="file in modifiedFiles" :key="file.path">
                        <button @click="viewDiff(file)"
                                class="w-full text-left p-2 bg-gray-700 hover:bg-gray-600 rounded text-sm">
                            <div class="flex items-center justify-between">
                                <span x-text="file.name" class="text-blue-300"></span>
                                <span class="text-xs" :class="file.status === 'modified' ? 'text-yellow-400' : 'text-green-400'"
                                      x-text="file.status"></span>
                            </div>
                        </button>
                    </template>
                </div>
            </div>

            <!-- Diff Viewer -->
            <div class="flex-1 overflow-hidden">
                <div class="h-full overflow-y-auto p-4">
                    <div x-show="currentDiff" class="diff-viewer text-xs">
                        <pre x-html="currentDiff" class="whitespace-pre-wrap"></pre>
                    </div>
                    <div x-show="!currentDiff" class="text-gray-500 text-center mt-8">
                        Select a file to view changes
                    </div>
                </div>
            </div>

            <!-- Diff Actions -->
            <div class="p-4 border-t border-gray-700">
                <div class="space-y-2">
                    <button @click="acceptChanges()"
                            class="w-full bg-green-600 hover:bg-green-700 px-3 py-2 rounded text-sm">
                        ‚úì Accept Changes
                    </button>
                    <button @click="rejectChanges()"
                            class="w-full bg-red-600 hover:bg-red-700 px-3 py-2 rounded text-sm">
                        ‚úó Reject Changes
                    </button>
                    <button @click="viewFullDiff()"
                            class="w-full bg-blue-600 hover:bg-blue-700 px-3 py-2 rounded text-sm">
                        üìÑ Full Diff
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Inline Editor Overlay -->
    <div x-show="showInlineEditorPanel" class="inline-editor-overlay" @click.self="hideInlineEditor()">
        <div class="inline-editor-panel">
            <!-- Toolbar -->
            <div class="inline-editor-toolbar">
                <div class="flex items-center justify-between w-full">
                    <div class="flex items-center space-x-3">
                        <h3 class="text-sm font-medium text-white">Inline Editor</h3>
                        <select x-model="inlineEditMode" @change="updateEditMode()"
                                class="bg-gray-600 border border-gray-500 rounded px-2 py-1 text-xs">
                            <option value="selection">Selection Edit</option>
                            <option value="cursor">Cursor Complete</option>
                            <option value="ghost_text">Ghost Text</option>
                            <option value="quick_question">Quick Question</option>
                            <option value="refinement">Refinement</option>
                        </select>
                    </div>

                    <div class="flex items-center space-x-2">
                        <span class="text-xs text-gray-300">Actions:</span>
                        <select x-model="inlineEditAction"
                                class="bg-gray-600 border border-gray-500 rounded px-2 py-1 text-xs">
                            <option value="generate">Generate</option>
                            <option value="refine">Refine</option>
                            <option value="explain">Explain</option>
                            <option value="complete">Complete</option>
                            <option value="transform">Transform</option>
                            <option value="review">Review</option>
                        </select>

                        <button @click="hideInlineEditor()"
                                class="text-gray-400 hover:text-white">
                            ‚úï
                        </button>
                    </div>
                </div>
            </div>

            <!-- Editor Content -->
            <div class="p-4">
                <!-- Context Drag Zone -->
                <div class="context-drag-zone mb-4"
                     @dragover.prevent="handleDragOver($event)"
                     @dragleave="handleDragLeave($event)"
                     @drop="handleContextDrop($event)">
                    <div x-show="!draggedContext.length">
                        üìÅ Drag files or text here for context
                    </div>
                    <div x-show="draggedContext.length" class="text-blue-400">
                        <span x-text="draggedContext.length"></span> context items added
                    </div>
                </div>

                <!-- Selection Display -->
                <div x-show="currentSelection" class="mb-4">
                    <label class="block text-sm text-gray-300 mb-2">Selected Code:</label>
                    <div class="code-editor bg-gray-800 text-sm" x-text="currentSelection?.text"></div>
                    <div class="text-xs text-gray-400 mt-1">
                        Lines <span x-text="currentSelection?.start_line"></span>-<span x-text="currentSelection?.end_line"></span>
                        in <span x-text="currentSelection?.file_path"></span>
                    </div>
                </div>

                <!-- Prompt Input -->
                <div class="mb-4">
                    <label class="block text-sm text-gray-300 mb-2">What would you like to do?</label>
                    <textarea x-model="inlineEditPrompt"
                              @keydown.ctrl.enter="executeInlineEdit()"
                              placeholder="Describe what you want to generate, refine, or explain..."
                              class="w-full code-editor text-sm"
                              rows="3"></textarea>
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions">
                    <button @click="quickAction('add_docstring')" class="quick-action-btn">
                        üìù Add Docstring
                    </button>
                    <button @click="quickAction('add_type_hints')" class="quick-action-btn">
                        üè∑Ô∏è Add Type Hints
                    </button>
                    <button @click="quickAction('refactor')" class="quick-action-btn">
                        üîß Refactor
                    </button>
                    <button @click="quickAction('explain')" class="quick-action-btn">
                        üí° Explain
                    </button>
                    <button @click="quickAction('optimize')" class="quick-action-btn">
                        ‚ö° Optimize
                    </button>
                </div>

                <!-- Refinement Workflow -->
                <div x-show="inlineEditMode === 'refinement'" class="refinement-workflow">
                    <div class="workflow-step" :class="workflowStep >= 1 ? 'completed' : (workflowStep === 0 ? 'active' : '')">
                        <span class="text-sm">üîç Critic Analysis</span>
                        <span x-show="workflowStep >= 1" class="text-green-400 text-xs">‚úì</span>
                    </div>
                    <div class="workflow-step" :class="workflowStep >= 2 ? 'completed' : (workflowStep === 1 ? 'active' : '')">
                        <span class="text-sm">üõ†Ô∏è Refiner Improvements</span>
                        <span x-show="workflowStep >= 2" class="text-green-400 text-xs">‚úì</span>
                    </div>
                    <div class="workflow-step" :class="workflowStep >= 3 ? 'completed' : (workflowStep === 2 ? 'active' : '')">
                        <span class="text-sm">‚öñÔ∏è Evaluator Assessment</span>
                        <span x-show="workflowStep >= 3" class="text-green-400 text-xs">‚úì</span>
                    </div>
                </div>

                <!-- Result Display -->
                <div x-show="inlineEditResult" class="mt-4">
                    <div class="flex items-center justify-between mb-2">
                        <label class="text-sm text-gray-300">Result:</label>
                        <div class="flex space-x-2">
                            <button @click="acceptInlineEdit()"
                                    class="bg-green-600 hover:bg-green-700 px-3 py-1 rounded text-xs">
                                ‚úì Accept
                            </button>
                            <button @click="rejectInlineEdit()"
                                    class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-xs">
                                ‚úó Reject
                            </button>
                            <button @click="refineInlineEdit()"
                                    class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-xs">
                                üîß Refine
                            </button>
                        </div>
                    </div>
                    <div class="code-editor bg-gray-800 text-sm" x-html="formatInlineResult(inlineEditResult)"></div>

                    <!-- Alternatives -->
                    <div x-show="inlineEditAlternatives.length" class="mt-3">
                        <label class="text-xs text-gray-400 mb-1 block">Alternatives:</label>
                        <div class="space-y-1">
                            <template x-for="(alt, index) in inlineEditAlternatives" :key="index">
                                <button @click="selectAlternative(index)"
                                        class="w-full text-left p-2 bg-gray-700 hover:bg-gray-600 rounded text-xs">
                                    <span x-text="alt.substring(0, 80) + '...'" class="text-gray-300"></span>
                                </button>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Execute Button -->
                <div class="flex justify-between items-center mt-4">
                    <div class="text-xs text-gray-400">
                        <span class="keyboard-shortcut">Ctrl+Enter</span> Execute
                    </div>
                    <button @click="executeInlineEdit()"
                            :disabled="!inlineEditPrompt.trim()"
                            class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 px-4 py-2 rounded text-sm">
                        Execute Edit
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Command Palette Overlay -->
    <div x-show="showCommandPalette" class="command-palette-overlay" @click.self="hideCommandPalette()">
        <div class="command-palette-panel">
            <!-- Search Input -->
            <div class="command-palette-search">
                <input type="text"
                       x-model="commandPaletteQuery"
                       @input="searchCommands()"
                       @keydown="handleCommandPaletteKeys($event)"
                       placeholder="Type a command or search..."
                       class="command-palette-input"
                       x-ref="commandPaletteInput">
            </div>

            <!-- Category Filters -->
            <div x-show="commandCategories.length > 0" class="command-category-filter">
                <div class="category-filter-chip"
                     :class="selectedCommandCategory === 'all' ? 'active' : ''"
                     @click="filterByCategory('all')">
                    All
                </div>
                <template x-for="category in commandCategories" :key="category">
                    <div class="category-filter-chip"
                         :class="selectedCommandCategory === category ? 'active' : ''"
                         @click="filterByCategory(category)"
                         x-text="category.charAt(0).toUpperCase() + category.slice(1)">
                    </div>
                </template>
            </div>

            <!-- Recent Commands (when no query) -->
            <div x-show="!commandPaletteQuery && recentCommands.length > 0" class="command-recent-section">
                <div class="command-recent-title">Recent Commands</div>
                <div class="command-recent-items">
                    <template x-for="recent in recentCommands.slice(0, 8)" :key="recent.id">
                        <div class="command-recent-item"
                             @click="executeCommandById(recent.id)"
                             x-text="recent.title">
                        </div>
                    </template>
                </div>
            </div>

            <!-- Command Results -->
            <div class="command-palette-results">
                <template x-for="(result, index) in filteredCommandResults" :key="result.command.id">
                    <div class="command-palette-item"
                         :class="commandSelectedIndex === index ? 'selected' : ''"
                         @click="executeSelectedCommand(index)"
                         @mouseenter="commandSelectedIndex = index">

                        <div class="command-item-left">
                            <!-- Icon -->
                            <div class="command-item-icon">
                                <span x-show="result.command.icon" x-text="getCommandIcon(result.command.icon)"></span>
                                <span x-show="!result.command.icon">üìã</span>
                            </div>

                            <!-- Content -->
                            <div class="command-item-content">
                                <div class="command-item-title"
                                     x-html="highlightMatch(result.command.title, commandPaletteQuery, result.match_positions)">
                                </div>
                                <div class="command-item-description" x-text="result.command.description"></div>
                            </div>
                        </div>

                        <div class="command-item-right">
                            <!-- Favorite Star -->
                            <div x-show="result.command.is_favorite" class="command-item-favorite">‚òÖ</div>

                            <!-- Category -->
                            <div class="command-item-category" x-text="result.command.category"></div>

                            <!-- Keyboard Shortcut -->
                            <div x-show="result.command.shortcuts && result.command.shortcuts.length > 0"
                                 class="command-item-shortcut"
                                 x-text="formatShortcut(result.command.shortcuts[0].key)">
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Empty State -->
                <div x-show="filteredCommandResults.length === 0 && commandPaletteQuery" class="command-palette-empty">
                    <div class="command-palette-empty-icon">üîç</div>
                    <div>No commands found for "<span x-text="commandPaletteQuery"></span>"</div>
                    <div class="text-xs mt-2">Try a different search term or check spelling</div>
                </div>

                <div x-show="filteredCommandResults.length === 0 && !commandPaletteQuery && recentCommands.length === 0" class="command-palette-empty">
                    <div class="command-palette-empty-icon">‚å®Ô∏è</div>
                    <div>Start typing to search commands</div>
                    <div class="text-xs mt-2">Or use <span class="keyboard-shortcut">Ctrl+Shift+P</span> to see all commands</div>
                </div>
            </div>

            <!-- Footer -->
            <div class="command-palette-footer">
                <div class="command-palette-help">
                    <div class="command-palette-help-item">
                        <span class="keyboard-shortcut">‚Üë‚Üì</span> navigate
                    </div>
                    <div class="command-palette-help-item">
                        <span class="keyboard-shortcut">Enter</span> execute
                    </div>
                    <div class="command-palette-help-item">
                        <span class="keyboard-shortcut">Esc</span> close
                    </div>
                    <div class="command-palette-help-item">
                        <span class="keyboard-shortcut">Ctrl+,</span> favorites
                    </div>
                </div>
                <div class="command-palette-status" x-text="getCommandPaletteStatus()"></div>
            </div>
        </div>
    </div>

    <!-- Edit Mode Indicator -->
    <div x-show="inlineEditMode && !showInlineEditorPanel" class="edit-mode-indicator">
        <div class="flex items-center space-x-2">
            <span>üéØ</span>
            <span x-text="inlineEditMode.replace('_', ' ').toUpperCase()"></span>
            <span class="keyboard-shortcut">Ctrl+K</span>
        </div>
    </div>

    <!-- WebSocket Connection Indicator -->
    <div x-show="!connected" class="fixed bottom-4 right-4 bg-red-600 text-white px-4 py-2 rounded shadow-lg">
        Disconnected - Attempting to reconnect...
    </div>

    <script>
        function torqConsole() {
            return {
                // Debug Mode (set to false for production)
                debug: false,

                // Core State
                connected: false,
                sessionId: '',
                selectedModel: 'claude-sonnet-4-5-20250929',

                // Command Palette State
                showCommandPalette: false,
                commandPaletteQuery: '',
                commandSelectedIndex: 0,
                commandResults: [],
                filteredCommandResults: [],
                recentCommands: [],
                favoriteCommands: [],
                commandCategories: ['general', 'file', 'edit', 'view', 'chat', 'context', 'ai', 'workspace'],
                selectedCommandCategory: 'all',
                commandPaletteHistory: [],

                // Inline Editor State
                showInlineEditorPanel: false,
                inlineEditMode: 'selection',
                inlineEditAction: 'generate',
                inlineEditPrompt: '',
                inlineEditResult: '',
                inlineEditAlternatives: [],
                currentSelection: null,
                activeGhostText: null,
                draggedContext: [],
                workflowStep: 0,

                // UI State
                showGuidedPrompt: true,
                guidedPromptText: 'Connect to GitHub for project examples? Or start with web research for inspiration?',

                // Mode State
                ideationMode: false,
                planningMode: false,
                codeWritingMode: false,
                imageGenerationMode: false,
                videoGenerationMode: false,
                voiceEnabled: false,
                showGitHubPushDialog: false,
                showCommandPalette: false,

                // MCP State
                mcpServers: [],
                mcpTools: [],
                mcpCategories: [],
                selectedMcpCategory: 'all',
                mcpSearchQuery: '',
                filteredMcpTools: [],
                showToolParams: null,

                // Chat State
                messages: [],
                currentMessage: '',
                selectedTools: [],  // Empty by default - only use tools when explicitly requested
                activeTools: [],
                sessionActive: false,

                // Diff State
                diffTool: 'delta',
                modifiedFiles: [],
                currentDiff: '',

                // Socket.IO
                socket: null,

                init() {
                    this.connectWebSocket();
                    this.loadInitialData();
                    this.setupVoiceRecognition();
                    this.setupGlobalKeyboardShortcuts();
                },

                setupGlobalKeyboardShortcuts() {
                    // Global keyboard shortcut handler
                    document.addEventListener('keydown', (event) => {
                        // Only handle if not typing in input fields (unless it's a global shortcut)
                        const isTyping = event.target.tagName === 'INPUT' ||
                                        event.target.tagName === 'TEXTAREA' ||
                                        event.target.contentEditable === 'true';

                        // Always handle global shortcuts
                        if (event.ctrlKey && event.shiftKey && event.key === 'P') {
                            event.preventDefault();
                            this.toggleCommandPalette();
                            return;
                        }

                        // Skip other shortcuts if typing (except in command palette)
                        if (isTyping && !this.showCommandPalette) {
                            return;
                        }

                        // Handle other shortcuts
                        this.handleKeyboardShortcuts(event);
                    });
                },

                connectWebSocket() {
                    // Use Socket.IO instead of raw WebSocket
                    this.socket = io({
                        transports: ['polling', 'websocket'],
                        reconnection: true,
                        reconnectionDelay: 3000,
                        reconnectionAttempts: 10
                    });

                    this.socket.on('connect', () => {
                        this.connected = true;
                        if (this.debug) console.log('Socket.IO connected');
                    });

                    this.socket.on('message', (data) => {
                        this.handleWebSocketMessage(data);
                    });

                    this.socket.on('disconnect', () => {
                        this.connected = false;
                        if (this.debug) console.log('Socket.IO disconnected');
                    });

                    this.socket.on('connect_error', (error) => {
                        this.connected = false;
                        if (this.debug) console.error('Socket.IO connection error:', error);
                    });
                },

                async loadInitialData() {
                    try {
                        // Load console info
                        const response = await fetch('/api/console/info');
                        const data = await response.json();
                        this.sessionId = data.session_id || 'new';

                        // Load MCP tools with enhanced metadata
                        const mcpResponse = await fetch('/api/mcp/tools');
                        const mcpData = await mcpResponse.json();
                        this.mcpTools = mcpData.tools || [];
                        this.mcpCategories = mcpData.categories || [];
                        this.mcpServers = mcpData.servers || [];

                        // Initialize filtered tools
                        this.filteredMcpTools = this.mcpTools;

                        // Load modified files
                        this.loadModifiedFiles();
                    } catch (error) {
                        console.error('Failed to load initial data:', error);
                    }
                },

                async sendMessage() {
                    if (!this.currentMessage.trim()) return;

                    const userMessage = {
                        id: Date.now(),
                        role: 'user',
                        content: this.currentMessage,
                        timestamp: new Date().toLocaleTimeString()
                    };

                    this.messages.push(userMessage);

                    try {
                        // Use /api/chat for AI responses and web search
                        const response = await fetch('/api/chat', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                message: this.currentMessage,
                                session_id: this.sessionId || 'web-session',
                                tools: this.selectedTools.length > 0 ? this.selectedTools : undefined,  // Only send tools if explicitly selected
                                stream: false
                            })
                        });

                        const data = await response.json();

                        if (data.success) {
                            const aiMessage = {
                                id: Date.now() + 1,
                                role: 'assistant',
                                content: data.response || data.content || 'No response received',
                                timestamp: new Date().toLocaleTimeString()
                            };
                            this.messages.push(aiMessage);
                            this.loadModifiedFiles();
                        }
                    } catch (error) {
                        console.error('Error sending message:', error);
                    }

                    this.currentMessage = '';
                },

                getActiveMode() {
                    if (this.ideationMode) return 'ideation';
                    if (this.planningMode) return 'planning';
                    return 'normal';
                },

                toggleMode(mode) {
                    if (mode === 'ideation') {
                        this.ideationMode = !this.ideationMode;
                        if (this.ideationMode) this.planningMode = false;
                    } else if (mode === 'planning') {
                        this.planningMode = !this.planningMode;
                        if (this.planningMode) this.ideationMode = false;
                    } else if (mode === 'voice') {
                        this.toggleVoice();
                    }
                },

                async connectMCP() {
                    // Show MCP connection dialog
                    const endpoint = prompt('Enter MCP server endpoint:', 'http://localhost:3100');
                    if (endpoint) {
                        try {
                            const response = await fetch('/api/mcp/connect', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({endpoint})
                            });
                            if (response.ok) {
                                this.loadInitialData();
                            }
                        } catch (error) {
                            console.error('MCP connection failed:', error);
                        }
                    }
                },

                suggestTool(tool) {
                    this.currentMessage = `Use ${tool.name}: ${tool.description}`;
                },

                useMcpTool(tool) {
                    // Enhanced tool usage with friendly description
                    const prompt = `${tool.icon} Use ${tool.name} - ${tool.user_friendly_description}\n\nüí° ${tool.use_case}\n\nI want to: `;
                    this.currentMessage = prompt;

                    // Auto-focus on the input
                    this.$nextTick(() => {
                        const input = document.querySelector('input[x-model="currentMessage"]');
                        if (input) {
                            input.focus();
                            // Position cursor at the end
                            input.setSelectionRange(input.value.length, input.value.length);
                        }
                    });
                },

                filterMcpTools() {
                    let tools = this.mcpTools;

                    // Filter by category
                    if (this.selectedMcpCategory !== 'all') {
                        tools = tools.filter(tool => tool.category === this.selectedMcpCategory);
                    }

                    // Filter by search query
                    if (this.mcpSearchQuery.trim()) {
                        const query = this.mcpSearchQuery.toLowerCase();
                        tools = tools.filter(tool => {
                            return tool.name.toLowerCase().includes(query) ||
                                   tool.user_friendly_description.toLowerCase().includes(query) ||
                                   tool.use_case.toLowerCase().includes(query) ||
                                   tool.category.toLowerCase().includes(query) ||
                                   (tool.description && tool.description.toLowerCase().includes(query));
                        });
                    }

                    this.filteredMcpTools = tools;
                },

                startIdeation(type) {
                    // Toggle the specific ideation mode
                    if (type === 'web') {
                        // Toggle web search mode
                        if (this.activeTools.includes('web_search')) {
                            // Turn off
                            this.selectedTools = [];
                            this.activeTools = [];
                            this.ideationMode = false;
                            this.currentMessage = '';
                        } else {
                            // Turn on
                            this.selectedTools = ['web_search'];
                            this.activeTools = ['web_search'];
                            this.ideationMode = true;
                            this.currentMessage = 'search web for ';
                        }
                    } else if (type === 'github') {
                        // Toggle GitHub examples mode
                        if (this.activeTools.includes('github_examples')) {
                            // Turn off
                            this.selectedTools = [];
                            this.activeTools = [];
                            this.ideationMode = false;
                            this.currentMessage = '';
                        } else {
                            // Turn on
                            this.selectedTools = ['github_examples'];
                            this.activeTools = ['github_examples'];
                            this.ideationMode = true;
                            this.currentMessage = 'Find GitHub examples for ';
                        }
                    }
                    // Auto-focus on AI Assistant input if enabled
                    if (this.ideationMode) {
                        this.$nextTick(() => {
                            const input = this.$el.querySelector('input[placeholder*="Ask AI assistant"]');
                            if (input) input.focus();
                        });
                    }
                },

                startPrototyping() {
                    this.planningMode = !this.planningMode;
                    if (this.planningMode) {
                        this.currentMessage = 'Plan a multi-file prototype with architecture overview';
                    } else {
                        this.currentMessage = '';
                    }
                },

                startCodeWriting() {
                    this.codeWritingMode = !this.codeWritingMode;
                    if (this.codeWritingMode) {
                        this.currentMessage = 'I need you to write/update code for: ';
                        // Focus on the message input
                        this.$nextTick(() => {
                            const input = document.querySelector('textarea[x-model="currentMessage"]');
                            if (input) {
                                input.focus();
                                // Position cursor at the end
                                input.setSelectionRange(input.value.length, input.value.length);
                            }
                        });
                    } else {
                        this.currentMessage = '';
                    }
                },

                startImageGeneration() {
                    this.imageGenerationMode = !this.imageGenerationMode;
                    if (this.imageGenerationMode) {
                        this.currentMessage = 'Generate an image of: ';
                        this.$nextTick(() => {
                            const input = document.querySelector('textarea[x-model="currentMessage"]');
                            if (input) {
                                input.focus();
                                input.setSelectionRange(input.value.length, input.value.length);
                            }
                        });
                    } else {
                        this.currentMessage = '';
                    }
                },

                startVideoGeneration() {
                    this.videoGenerationMode = !this.videoGenerationMode;
                    if (this.videoGenerationMode) {
                        this.currentMessage = 'Create a video showing: ';
                        this.$nextTick(() => {
                            const input = document.querySelector('textarea[x-model="currentMessage"]');
                            if (input) {
                                input.focus();
                                input.setSelectionRange(input.value.length, input.value.length);
                            }
                        });
                    } else {
                        this.currentMessage = '';
                    }
                },

                pushToGitHub() {
                    this.showGitHubPushDialog = true;
                },

                closePushDialog() {
                    this.showGitHubPushDialog = false;
                },

                async executePushToGitHub(repoName, branch, commitMessage, isPrivate, createIfMissing) {
                    try {
                        const response = await fetch('/api/github/push', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                repo_name: repoName,
                                branch: branch || 'main',
                                commit_message: commitMessage || 'Initial commit via TORQ Console',
                                private: isPrivate || false,
                                create_if_missing: createIfMissing || true
                            })
                        });

                        const data = await response.json();

                        if (data.success) {
                            this.showNotification('‚úÖ Successfully pushed to GitHub! ' + data.url, 'success');
                            this.closePushDialog();
                        } else {
                            this.showNotification('‚ùå Error: ' + data.error, 'error');
                        }
                    } catch (error) {
                        this.showNotification('‚ùå Failed to push to GitHub: ' + error.message, 'error');
                    }
                },

                showNotification(message, type = 'info') {
                    // Simple notification system
                    const notification = document.createElement('div');
                    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
                        type === 'success' ? 'bg-green-600' :
                        type === 'error' ? 'bg-red-600' :
                        'bg-blue-600'
                    } text-white`;
                    notification.textContent = message;
                    document.body.appendChild(notification);

                    setTimeout(() => {
                        notification.remove();
                    }, 5000);
                },

                toggleVoice() {
                    this.voiceEnabled = !this.voiceEnabled;
                    if (this.voiceEnabled) {
                        this.startVoiceRecognition();
                    } else {
                        this.stopVoiceRecognition();
                    }
                },

                setupVoiceRecognition() {
                    if ('webkitSpeechRecognition' in window) {
                        this.recognition = new webkitSpeechRecognition();
                        this.recognition.continuous = true;
                        this.recognition.interimResults = true;

                        this.recognition.onresult = (event) => {
                            let finalTranscript = '';
                            for (let i = event.resultIndex; i < event.results.length; i++) {
                                if (event.results[i].isFinal) {
                                    finalTranscript += event.results[i][0].transcript;
                                }
                            }
                            if (finalTranscript) {
                                this.currentMessage = finalTranscript;
                                this.sendMessage();
                            }
                        };
                    }
                },

                startVoiceRecognition() {
                    if (this.recognition) {
                        this.recognition.start();
                    }
                },

                stopVoiceRecognition() {
                    if (this.recognition) {
                        this.recognition.stop();
                    }
                },

                async loadModifiedFiles() {
                    try {
                        const response = await fetch('/api/files');
                        const data = await response.json();
                        this.modifiedFiles = data.files || [];
                    } catch (error) {
                        console.error('Failed to load files:', error);
                    }
                },

                async viewDiff(file) {
                    try {
                        const response = await fetch(`/api/diff?file=${encodeURIComponent(file.path)}&tool=${this.diffTool}`);
                        const data = await response.json();
                        this.currentDiff = data.diff || 'No changes';
                    } catch (error) {
                        console.error('Failed to load diff:', error);
                    }
                },

                async updateModel() {
                    try {
                        await fetch('/api/console/model', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({model: this.selectedModel})
                        });
                    } catch (error) {
                        console.error('Failed to update model:', error);
                    }
                },

                acceptGuidedPrompt() {
                    this.currentMessage = this.guidedPromptText.replace('?', '');
                    this.showGuidedPrompt = false;
                },

                dismissGuidedPrompt() {
                    this.showGuidedPrompt = false;
                },

                newSession() {
                    this.sessionActive = true;
                    this.messages = [];
                    this.currentMessage = '';
                    // Clear session and reload
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                },

                exportWorkflow() {
                    if (this.debug) console.log('Export workflow functionality to be implemented');
                },

                async acceptChanges() {
                    try {
                        const response = await fetch('/api/git/commit', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                message: 'Accept changes from TORQ CONSOLE',
                                files: this.modifiedFiles.map(f => f.path)
                            })
                        });

                        if (response.ok) {
                            alert('Changes accepted and committed successfully!');
                            this.modifiedFiles = [];
                            this.currentDiff = '';
                            this.loadModifiedFiles();
                        } else {
                            alert('Failed to accept changes');
                        }
                    } catch (error) {
                        console.error('Error accepting changes:', error);
                        alert('Error accepting changes');
                    }
                },

                async rejectChanges() {
                    if (confirm('Are you sure you want to reject all changes? This cannot be undone.')) {
                        try {
                            const response = await fetch('/api/git/reset', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({hard: false})
                            });

                            if (response.ok) {
                                alert('Changes rejected successfully!');
                                this.modifiedFiles = [];
                                this.currentDiff = '';
                                this.loadModifiedFiles();
                            } else {
                                alert('Failed to reject changes');
                            }
                        } catch (error) {
                            console.error('Error rejecting changes:', error);
                            alert('Error rejecting changes');
                        }
                    }
                },

                async viewFullDiff() {
                    try {
                        const response = await fetch('/api/diff?full=true');
                        const data = await response.json();

                        // Open diff in new window
                        const diffWindow = window.open('', '_blank');
                        diffWindow.document.write(`
                            <!DOCTYPE html>
                            <html>
                            <head><title>Full Diff - TORQ CONSOLE</title>
                            <style>
                                body { font-family: monospace; background: #1a1a1a; color: #fff; padding: 20px; }
                                pre { white-space: pre-wrap; }
                                .added { background: #0d4429; }
                                .removed { background: #5a1e1e; }
                            </style></head>
                            <body><h1>Full Project Diff</h1><pre>${data.diff || 'No changes'}</pre></body>
                            </html>
                        `);
                    } catch (error) {
                        console.error('Error viewing full diff:', error);
                        alert('Error loading full diff');
                    }
                },

                handleWebSocketMessage(data) {
                    // Handle real-time updates
                    if (this.debug) console.log('WebSocket message:', data);
                },

                // Inline Editor Methods
                showInlineEditor() {
                    this.showInlineEditorPanel = true;
                    this.inlineEditPrompt = '';
                    this.inlineEditResult = '';
                    this.workflowStep = 0;
                },

                hideInlineEditor() {
                    this.showInlineEditorPanel = false;
                    this.activeGhostText = null;
                },

                handleKeyboardShortcuts(event) {
                    // Ctrl+Shift+P - Command Palette
                    if (event.ctrlKey && event.shiftKey && event.key === 'P') {
                        event.preventDefault();
                        this.toggleCommandPalette();
                        return;
                    }

                    // Ctrl+K - Inline Edit
                    if (event.ctrlKey && event.key === 'k') {
                        event.preventDefault();
                        this.showInlineEditor();
                        return;
                    }

                    // Alt+Enter - Quick Question
                    if (event.altKey && event.key === 'Enter') {
                        event.preventDefault();
                        this.quickQuestion();
                        return;
                    }

                    // Tab - Accept Ghost Text
                    if (event.key === 'Tab' && this.activeGhostText) {
                        event.preventDefault();
                        this.acceptGhostText();
                        return;
                    }

                    // Escape - Dismiss Ghost Text or Close Command Palette
                    if (event.key === 'Escape') {
                        if (this.showCommandPalette) {
                            event.preventDefault();
                            this.hideCommandPalette();
                            return;
                        }
                        if (this.activeGhostText) {
                            event.preventDefault();
                            this.dismissGhostText();
                            return;
                        }
                    }

                    // Ctrl+. - Code Actions
                    if (event.ctrlKey && event.key === '.') {
                        event.preventDefault();
                        this.showCodeActions();
                        return;
                    }

                    // Ctrl+Shift+I - Quick Fix
                    if (event.ctrlKey && event.shiftKey && event.key === 'I') {
                        event.preventDefault();
                        this.showQuickFix();
                        return;
                    }

                    // Ctrl+T - New Chat Tab
                    if (event.ctrlKey && event.key === 't' && !this.showCommandPalette) {
                        event.preventDefault();
                        this.executeCommand('chat.new_tab');
                        return;
                    }

                    // Ctrl+W - Close Chat Tab
                    if (event.ctrlKey && event.key === 'w' && !this.showCommandPalette) {
                        event.preventDefault();
                        this.executeCommand('chat.close_tab');
                        return;
                    }
                },

                async executeInlineEdit() {
                    if (!this.inlineEditPrompt.trim()) return;

                    try {
                        this.workflowStep = 0;

                        const requestData = {
                            id: Date.now().toString(),
                            mode: this.inlineEditMode,
                            action: this.inlineEditAction,
                            prompt: this.inlineEditPrompt,
                            selection: this.currentSelection,
                            metadata: {
                                use_refinement: this.inlineEditMode === 'refinement',
                                context: this.draggedContext
                            }
                        };

                        const response = await fetch('/api/inline-edit', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(requestData)
                        });

                        const data = await response.json();

                        if (data.success) {
                            this.inlineEditResult = data.content;
                            this.inlineEditAlternatives = data.alternatives || [];

                            // Handle ghost text
                            if (data.ghost_text) {
                                this.activeGhostText = data.ghost_text;
                            }

                            // Update workflow progress
                            if (data.metadata?.workflow_results) {
                                this.animateWorkflowProgress();
                            }

                            // Show result in main chat if explanation
                            if (data.explanation) {
                                this.addMessageToChat('assistant', data.explanation);
                            }
                        } else {
                            alert('Error: ' + data.content);
                        }
                    } catch (error) {
                        console.error('Inline edit error:', error);
                        alert('Failed to execute inline edit');
                    }
                },

                async animateWorkflowProgress() {
                    for (let step = 1; step <= 3; step++) {
                        await new Promise(resolve => setTimeout(resolve, 800));
                        this.workflowStep = step;
                    }
                },

                quickAction(action) {
                    const prompts = {
                        'add_docstring': 'Add comprehensive docstring with parameters and return value',
                        'add_type_hints': 'Add type hints to function parameters and return type',
                        'refactor': 'Refactor this code for better readability and maintainability',
                        'explain': 'Explain what this code does and how it works',
                        'optimize': 'Optimize this code for better performance'
                    };

                    this.inlineEditPrompt = prompts[action] || action;
                    this.inlineEditAction = action === 'explain' ? 'explain' : 'refine';
                },

                acceptInlineEdit() {
                    if (this.inlineEditResult) {
                        // Apply the edit (this would integrate with file system)
                        if (this.debug) console.log('Accepting edit:', this.inlineEditResult);
                        this.addMessageToChat('assistant', '‚úÖ Edit applied successfully!');
                        this.hideInlineEditor();
                    }
                },

                rejectInlineEdit() {
                    this.inlineEditResult = '';
                    this.inlineEditAlternatives = [];
                    this.addMessageToChat('assistant', '‚ùå Edit rejected');
                },

                refineInlineEdit() {
                    this.inlineEditMode = 'refinement';
                    this.inlineEditPrompt = 'Refine and improve this: ' + this.inlineEditResult;
                    this.inlineEditResult = '';
                },

                selectAlternative(index) {
                    if (this.inlineEditAlternatives[index]) {
                        this.inlineEditResult = this.inlineEditAlternatives[index];
                    }
                },

                formatInlineResult(result) {
                    // Simple code formatting
                    return result.replace(/\n/g, '<br>').replace(/  /g, '&nbsp;&nbsp;');
                },

                quickQuestion() {
                    this.inlineEditMode = 'quick_question';
                    this.inlineEditAction = 'explain';
                    this.inlineEditPrompt = this.currentMessage || 'What does this code do?';
                    this.showInlineEditor();
                },

                acceptGhostText() {
                    if (this.activeGhostText) {
                        this.currentMessage += this.activeGhostText.text;
                        this.dismissGhostText();
                    }
                },

                dismissGhostText() {
                    this.activeGhostText = null;
                },

                getGhostTextStyle() {
                    // Position ghost text near cursor
                    return {
                        left: '10px',
                        top: '30px'
                    };
                },

                showCodeActions() {
                    // Show code actions menu
                    if (this.debug) console.log('Showing code actions...');
                    this.showInlineEditor();
                    this.inlineEditPrompt = 'Show available code actions for this selection';
                },

                showQuickFix() {
                    // Show quick fix suggestions
                    if (this.debug) console.log('Showing quick fixes...');
                    this.showInlineEditor();
                    this.inlineEditAction = 'review';
                    this.inlineEditPrompt = 'Suggest quick fixes for this code';
                },

                handleDragOver(event) {
                    event.preventDefault();
                    event.currentTarget.classList.add('drag-over');
                },

                handleDragLeave(event) {
                    event.currentTarget.classList.remove('drag-over');
                },

                handleContextDrop(event) {
                    event.preventDefault();
                    event.currentTarget.classList.remove('drag-over');

                    // Handle dropped files or text
                    const files = Array.from(event.dataTransfer.files);
                    const text = event.dataTransfer.getData('text/plain');

                    if (files.length > 0) {
                        files.forEach(file => {
                            this.draggedContext.push({
                                type: 'file',
                                name: file.name,
                                path: file.path || file.name
                            });
                        });
                    } else if (text) {
                        this.draggedContext.push({
                            type: 'text',
                            content: text.substring(0, 100) + '...',
                            full_content: text
                        });
                    }
                },

                updateEditMode() {
                    // Update UI based on selected edit mode
                    if (this.debug) console.log('Edit mode changed to:', this.inlineEditMode);
                },

                addMessageToChat(role, content) {
                    const message = {
                        id: Date.now(),
                        role: role,
                        content: content,
                        timestamp: new Date().toLocaleTimeString()
                    };
                    this.messages.push(message);

                    // Scroll to bottom
                    this.$nextTick(() => {
                        const chatMessages = document.getElementById('chat-messages');
                        if (chatMessages) {
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        }
                    });
                },

                // Command Palette Methods
                async toggleCommandPalette() {
                    if (this.showCommandPalette) {
                        this.hideCommandPalette();
                    } else {
                        await this.showCommandPaletteDialog();
                    }
                },

                async showCommandPaletteDialog() {
                    try {
                        this.showCommandPalette = true;
                        this.commandPaletteQuery = '';
                        this.commandSelectedIndex = 0;

                        // Load commands if not already loaded
                        if (this.commandResults.length === 0) {
                            await this.loadCommands();
                        }

                        // Load recent commands
                        await this.loadRecentCommands();

                        // Filter initial results
                        this.filterCommandResults();

                        // Focus the input
                        this.$nextTick(() => {
                            if (this.$refs.commandPaletteInput) {
                                this.$refs.commandPaletteInput.focus();
                            }
                        });

                    } catch (error) {
                        console.error('Error showing command palette:', error);
                    }
                },

                hideCommandPalette() {
                    this.showCommandPalette = false;
                    this.commandPaletteQuery = '';
                    this.commandSelectedIndex = 0;
                    this.filteredCommandResults = [];
                },

                async loadCommands() {
                    try {
                        const response = await fetch('/api/command-palette/commands');
                        const data = await response.json();

                        if (data.success) {
                            this.commandResults = data.commands || [];
                        } else {
                            console.error('Failed to load commands:', data.error);
                            // Fallback to demo commands
                            this.commandResults = this.getDemoCommands();
                        }
                    } catch (error) {
                        console.error('Error loading commands:', error);
                        // Fallback to demo commands
                        this.commandResults = this.getDemoCommands();
                    }
                },

                async loadRecentCommands() {
                    try {
                        const response = await fetch('/api/command-palette/recent');
                        const data = await response.json();

                        if (data.success) {
                            this.recentCommands = data.commands || [];
                        }
                    } catch (error) {
                        console.debug('Could not load recent commands:', error);
                        this.recentCommands = [];
                    }
                },

                getDemoCommands() {
                    return [
                        {
                            command: {
                                id: 'general.command_palette',
                                title: 'Show Command Palette',
                                category: 'general',
                                description: 'Open the command palette',
                                icon: 'search',
                                shortcuts: [{ key: 'ctrl+shift+p' }],
                                is_favorite: false
                            },
                            score: 1.0,
                            match_type: 'title'
                        },
                        {
                            command: {
                                id: 'chat.new_tab',
                                title: 'New Chat Tab',
                                category: 'chat',
                                description: 'Create a new chat tab',
                                icon: 'plus',
                                shortcuts: [{ key: 'ctrl+t' }],
                                is_favorite: true
                            },
                            score: 1.0,
                            match_type: 'title'
                        },
                        {
                            command: {
                                id: 'edit.inline_edit',
                                title: 'Inline Edit',
                                category: 'edit',
                                description: 'Open inline editor',
                                icon: 'edit',
                                shortcuts: [{ key: 'ctrl+k' }],
                                is_favorite: false
                            },
                            score: 1.0,
                            match_type: 'title'
                        },
                        {
                            command: {
                                id: 'ai.explain_code',
                                title: 'Explain Code',
                                category: 'ai',
                                description: 'Explain the selected code',
                                icon: 'help-circle',
                                shortcuts: [],
                                is_favorite: false
                            },
                            score: 1.0,
                            match_type: 'title'
                        },
                        {
                            command: {
                                id: 'view.toggle_sidebar',
                                title: 'Toggle Sidebar',
                                category: 'view',
                                description: 'Show/hide the sidebar',
                                icon: 'sidebar',
                                shortcuts: [{ key: 'ctrl+b' }],
                                is_favorite: false
                            },
                            score: 1.0,
                            match_type: 'title'
                        }
                    ];
                },

                async searchCommands() {
                    try {
                        if (!this.commandPaletteQuery.trim()) {
                            this.filterCommandResults();
                            return;
                        }

                        const response = await fetch('/api/command-palette/search', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                query: this.commandPaletteQuery,
                                category: this.selectedCommandCategory
                            })
                        });

                        const data = await response.json();

                        if (data.success) {
                            this.filteredCommandResults = data.results || [];
                        } else {
                            // Fallback to local filtering
                            this.filterCommandResults();
                        }

                        this.commandSelectedIndex = 0;

                    } catch (error) {
                        console.error('Error searching commands:', error);
                        this.filterCommandResults();
                    }
                },

                filterCommandResults() {
                    let results = [...this.commandResults];

                    // Filter by category
                    if (this.selectedCommandCategory !== 'all') {
                        results = results.filter(result =>
                            result.command.category === this.selectedCommandCategory
                        );
                    }

                    // Filter by query (simple local search)
                    if (this.commandPaletteQuery.trim()) {
                        const query = this.commandPaletteQuery.toLowerCase();
                        results = results.filter(result => {
                            const cmd = result.command;
                            return cmd.title.toLowerCase().includes(query) ||
                                   cmd.description.toLowerCase().includes(query) ||
                                   cmd.category.toLowerCase().includes(query);
                        });

                        // Simple scoring
                        results.forEach(result => {
                            const query = this.commandPaletteQuery.toLowerCase();
                            const title = result.command.title.toLowerCase();

                            if (title.startsWith(query)) {
                                result.score = 1.0;
                            } else if (title.includes(query)) {
                                result.score = 0.8;
                            } else {
                                result.score = 0.5;
                            }
                        });

                        // Sort by score
                        results.sort((a, b) => b.score - a.score);
                    }

                    this.filteredCommandResults = results;
                    this.commandSelectedIndex = 0;
                },

                filterByCategory(category) {
                    this.selectedCommandCategory = category;
                    if (this.commandPaletteQuery.trim()) {
                        this.searchCommands();
                    } else {
                        this.filterCommandResults();
                    }
                },

                handleCommandPaletteKeys(event) {
                    if (event.key === 'ArrowDown') {
                        event.preventDefault();
                        this.commandSelectedIndex = Math.min(
                            this.filteredCommandResults.length - 1,
                            this.commandSelectedIndex + 1
                        );
                    } else if (event.key === 'ArrowUp') {
                        event.preventDefault();
                        this.commandSelectedIndex = Math.max(0, this.commandSelectedIndex - 1);
                    } else if (event.key === 'Enter') {
                        event.preventDefault();
                        this.executeSelectedCommand();
                    } else if (event.key === 'Escape') {
                        event.preventDefault();
                        this.hideCommandPalette();
                    } else if (event.key === 'PageDown') {
                        event.preventDefault();
                        this.commandSelectedIndex = Math.min(
                            this.filteredCommandResults.length - 1,
                            this.commandSelectedIndex + 10
                        );
                    } else if (event.key === 'PageUp') {
                        event.preventDefault();
                        this.commandSelectedIndex = Math.max(0, this.commandSelectedIndex - 10);
                    }
                },

                async executeSelectedCommand(index = null) {
                    const selectedIndex = index !== null ? index : this.commandSelectedIndex;

                    if (selectedIndex >= 0 && selectedIndex < this.filteredCommandResults.length) {
                        const result = this.filteredCommandResults[selectedIndex];
                        await this.executeCommand(result.command.id);
                    }
                },

                async executeCommandById(commandId) {
                    await this.executeCommand(commandId);
                },

                async executeCommand(commandId) {
                    try {
                        this.hideCommandPalette();

                        // Add to history
                        this.commandPaletteHistory.unshift({
                            id: commandId,
                            timestamp: new Date().toISOString()
                        });

                        // Keep only last 20 commands in history
                        if (this.commandPaletteHistory.length > 20) {
                            this.commandPaletteHistory = this.commandPaletteHistory.slice(0, 20);
                        }

                        // Execute the command
                        const response = await fetch('/api/command-palette/execute', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                command_id: commandId,
                                parameters: {}
                            })
                        });

                        const data = await response.json();

                        if (data.success) {
                            // Handle the command result
                            await this.handleCommandResult(commandId, data.result);
                        } else {
                            // Fallback to local command handling
                            await this.handleLocalCommand(commandId);
                        }

                    } catch (error) {
                        console.error('Error executing command:', error);
                        // Fallback to local command handling
                        await this.handleLocalCommand(commandId);
                    }
                },

                async handleCommandResult(commandId, result) {
                    // Handle different types of command results
                    if (result.action) {
                        switch (result.action) {
                            case 'show_inline_editor':
                                this.showInlineEditor();
                                break;
                            case 'show_quick_question':
                                this.quickQuestion();
                                break;
                            case 'toggle_command_palette':
                                this.toggleCommandPalette();
                                break;
                            case 'ui_toggle':
                                this.handleUIToggle(result.target);
                                break;
                            default:
                                if (this.debug) console.log('Command executed:', commandId, result);
                        }
                    } else {
                        if (this.debug) console.log('Command executed:', commandId, result);
                    }
                },

                async handleLocalCommand(commandId) {
                    // Handle common commands locally
                    switch (commandId) {
                        case 'general.command_palette':
                            this.toggleCommandPalette();
                            break;
                        case 'chat.new_tab':
                            this.newSession();
                            break;
                        case 'edit.inline_edit':
                            this.showInlineEditor();
                            break;
                        case 'edit.quick_question':
                            this.quickQuestion();
                            break;
                        case 'view.toggle_sidebar':
                            // Toggle sidebar visibility
                            if (this.debug) console.log('Toggle sidebar');
                            break;
                        default:
                            if (this.debug) console.log('Local command not implemented:', commandId);
                    }
                },

                handleUIToggle(target) {
                    // Handle UI toggle commands
                    switch (target) {
                        case 'toggle_sidebar':
                            if (this.debug) console.log('Toggle sidebar');
                            break;
                        case 'toggle_chat_panel':
                            if (this.debug) console.log('Toggle chat panel');
                            break;
                        case 'toggle_diff_panel':
                            if (this.debug) console.log('Toggle diff panel');
                            break;
                        default:
                            if (this.debug) console.log('UI toggle not implemented:', target);
                    }
                },

                getCommandIcon(icon) {
                    const iconMap = {
                        'search': 'üîç',
                        'plus': '‚ûï',
                        'edit': '‚úèÔ∏è',
                        'help-circle': '‚ùì',
                        'sidebar': 'üìã',
                        'file': 'üìÑ',
                        'folder': 'üìÅ',
                        'settings': '‚öôÔ∏è',
                        'save': 'üíæ',
                        'code': 'üíª',
                        'lightbulb': 'üí°',
                        'refresh-cw': 'üîÑ',
                        'message-square': 'üí¨',
                        'git-compare': 'üìä',
                        'eye-off': 'üëÅÔ∏è',
                        'x': '‚ùå',
                        'arrow-right': '‚Üí',
                        'download': '‚¨áÔ∏è',
                        'trash': 'üóëÔ∏è',
                        'file-plus': 'üìÑ‚ûï',
                        'book': 'üìñ',
                        'check-circle': '‚úÖ',
                        'zap': '‚ö°',
                        'folder-open': 'üìÇ',
                        'folder-x': 'üìÅ‚ùå'
                    };
                    return iconMap[icon] || 'üìã';
                },

                formatShortcut(shortcut) {
                    if (!shortcut) return '';

                    return shortcut
                        .replace(/ctrl/g, 'Ctrl')
                        .replace(/shift/g, 'Shift')
                        .replace(/alt/g, 'Alt')
                        .replace(/cmd/g, 'Ctrl')
                        .replace(/\+/g, '+');
                },

                highlightMatch(text, query, positions = []) {
                    if (!query || !text) return text;

                    if (positions && positions.length > 0) {
                        // Use provided match positions
                        let result = '';
                        let lastIndex = 0;

                        positions.forEach(([start, end]) => {
                            result += text.slice(lastIndex, start);
                            result += `<span class="command-match-highlight">${text.slice(start, end)}</span>`;
                            lastIndex = end;
                        });
                        result += text.slice(lastIndex);

                        return result;
                    } else {
                        // Simple highlighting
                        const regex = new RegExp(`(${query})`, 'gi');
                        return text.replace(regex, '<span class="command-match-highlight">$1</span>');
                    }
                },

                getCommandPaletteStatus() {
                    const totalResults = this.filteredCommandResults.length;
                    if (totalResults === 0) {
                        return 'No commands found';
                    }

                    const selectedIndex = this.commandSelectedIndex + 1;
                    return `${selectedIndex} of ${totalResults}`;
                }
            }
        }
    </script>

    <!-- GitHub Push Dialog Modal -->
    <div x-show="showGitHubPushDialog"
         x-cloak
         @click.self="closePushDialog()"
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
         style="display: none;">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 class="text-xl font-bold text-white mb-4">üöÄ Push to GitHub</h3>

            <form @submit.prevent="executePushToGitHub(
                $refs.repoName.value,
                $refs.branch.value,
                $refs.commitMessage.value,
                $refs.isPrivate.checked,
                $refs.createIfMissing.checked
            )">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Repository Name</label>
                        <input x-ref="repoName"
                               type="text"
                               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white"
                               placeholder="my-awesome-project"
                               required>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Branch</label>
                        <input x-ref="branch"
                               type="text"
                               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white"
                               value="main"
                               placeholder="main">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Commit Message</label>
                        <textarea x-ref="commitMessage"
                                  class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white"
                                  rows="2"
                                  placeholder="Initial commit via TORQ Console"></textarea>
                    </div>

                    <div class="flex items-center space-x-4">
                        <label class="flex items-center text-sm text-gray-300">
                            <input x-ref="isPrivate" type="radio" name="visibility" value="private" class="mr-2">
                            Private
                        </label>
                        <label class="flex items-center text-sm text-gray-300">
                            <input type="radio" name="visibility" value="public" checked class="mr-2">
                            Public
                        </label>
                    </div>

                    <div>
                        <label class="flex items-center text-sm text-gray-300">
                            <input x-ref="createIfMissing" type="checkbox" checked class="mr-2">
                            Create repository if it doesn't exist
                        </label>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button"
                            @click="closePushDialog()"
                            class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded text-white">
                        Cancel
                    </button>
                    <button type="submit"
                            class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded text-white">
                        Push to GitHub ‚Üí
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Command Palette -->
    <div x-show="showCommandPalette"
         x-cloak
         @click.self="showCommandPalette = false"
         @keydown.escape="showCommandPalette = false"
         class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center pt-20 z-50"
         style="display: none;">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl">
            <div class="p-4 border-b border-gray-700">
                <input type="text"
                       x-ref="commandPaletteInput"
                       @input="filterCommands($event.target.value)"
                       class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded text-white"
                       placeholder="üîç Search commands... (Ctrl+Shift+P)"
                       autofocus>
            </div>
            <div class="max-h-96 overflow-y-auto">
                <div class="p-2">
                    <button @click="startIdeation('web'); showCommandPalette = false"
                            class="w-full text-left px-4 py-2 hover:bg-gray-700 rounded text-gray-300">
                        <span class="text-green-400">üîç</span> Research Assistant
                    </button>
                    <button @click="startIdeation('github'); showCommandPalette = false"
                            class="w-full text-left px-4 py-2 hover:bg-gray-700 rounded text-gray-300">
                        <span class="text-purple-400">üìö</span> Code Library
                    </button>
                    <button @click="startPrototyping(); showCommandPalette = false"
                            class="w-full text-left px-4 py-2 hover:bg-gray-700 rounded text-gray-300">
                        <span class="text-blue-400">üèóÔ∏è</span> App Builder
                    </button>
                    <button @click="startCodeWriting(); showCommandPalette = false"
                            class="w-full text-left px-4 py-2 hover:bg-gray-700 rounded text-gray-300">
                        <span class="text-red-400">‚úçÔ∏è</span> Write/Update Code
                    </button>
                    <button @click="startImageGeneration(); showCommandPalette = false"
                            class="w-full text-left px-4 py-2 hover:bg-gray-700 rounded text-gray-300">
                        <span class="text-purple-400">üé®</span> Create Image
                    </button>
                    <button @click="startVideoGeneration(); showCommandPalette = false"
                            class="w-full text-left px-4 py-2 hover:bg-gray-700 rounded text-gray-300">
                        <span class="text-purple-400">üé¨</span> Create Video
                    </button>
                    <button @click="pushToGitHub(); showCommandPalette = false"
                            class="w-full text-left px-4 py-2 hover:bg-gray-700 rounded text-gray-300">
                        <span class="text-green-400">üöÄ</span> Push to GitHub
                    </button>
                    <button @click="newSession(); showCommandPalette = false"
                            class="w-full text-left px-4 py-2 hover:bg-gray-700 rounded text-gray-300">
                        <span class="text-blue-400">‚ûï</span> New Session
                    </button>
                    <button @click="toggleVoice(); showCommandPalette = false"
                            class="w-full text-left px-4 py-2 hover:bg-gray-700 rounded text-gray-300">
                        <span class="text-green-400">üé§</span> Voice Mode
                    </button>
                    <button @click="exportWorkflow(); showCommandPalette = false"
                            class="w-full text-left px-4 py-2 hover:bg-gray-700 rounded text-gray-300">
                        <span class="text-gray-400">üì§</span> Export Workflow
                    </button>
                </div>
            </div>
            <div class="p-3 border-t border-gray-700 text-xs text-gray-500 text-center">
                Press <kbd class="px-2 py-1 bg-gray-700 rounded">Esc</kbd> to close
            </div>
        </div>
    </div>

    <!-- Keyboard shortcut for Command Palette -->
    <script>
        document.addEventListener('keydown', function(e) {
            // Ctrl+Shift+P or Cmd+Shift+P
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'P') {
                e.preventDefault();
                Alpine.store('app').showCommandPalette = !Alpine.store('app').showCommandPalette;
                if (Alpine.store('app').showCommandPalette) {
                    setTimeout(() => {
                        document.querySelector('[x-ref="commandPaletteInput"]')?.focus();
                    }, 100);
                }
            }
        });
    </script>

</body>
</html>